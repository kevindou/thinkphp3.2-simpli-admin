<include file="Layout:indexHeader" />
<div class="row-fluid">
	<div ondesktop="span3" ontablet="span6" class="span3 smallstat box mobileHalf noMargin">
		<i class="icon-shopping-cart green"></i>
		<span class="title">订单数</span>
		<span class="value" id="count-total">{$count|default="0"}</span>
	</div>
	<div ondesktop="span3" ontablet="span6" class="span3 smallstat box mobileHalf noMargin">
		<i class="icon-credit-card yellow"></i>
		<span class="title">充值金额</span>
		<span class="value" id="money-total">{$money|default="0"}</span>
	</div>
	<div ondesktop="span3" ontablet="span6" class="span3 smallstat mobileHalf box">
		<i class="icon-money orange"></i>
		<span class="title">充值金币数</span>
		<span class="value" id="gold-total">{$gold|default="0"}</span>
	</div>
</div>
<div class="row-fluid">
	<div class="box span12">
		<div class="box-header">
			<h2>
				<i class="icon-edit"></i>
				订单统计查询
			</h2>
			<div class="box-icon">
				<a id="toggle-fullscreen" class="hidden-phone hidden-tablet" title="全屏" href="#"> 
                    <i class="icon-fullscreen"></i>
                </a>
				<a class="btn-minimize" title="隐藏" href="#"> 
                    <i class="icon-chevron-up"></i>
                </a>
                <a class="btn-close" title="删除" href="#">
                    <i class="icon-remove"></i>
                </a>
			</div>
		</div>
		<div class="box-content">
			<table class="table table-striped table-bordered table-hover" id="showTable">
            </table>
		</div>
	</div>
</div>
<style type="text/css">
	#showTable_filter label input, #showTable_filter label select {margin-top:6px;}
</style>
<script type="text/javascript">

	// 刷新统计数据
	function setCounts()
	{
		$.ajax({
        		url:'?m=Order&a=setCounts',
        		type:'get',
        		data:{
        			'sSearch':$('#showTable_filter input[type=search]').val(),
        			'sSearch_2':$('#m-agentId').val(),
        			'sSearch_3':$('#m-serverId').val(),
        			'sSearch_4':$('#date-start').val(),
        			'sSearch_5':$('#date-end').val(),
        		},
        		dataType:'json',
        		success:function(json)
        		{
        			for (var i in json) $('#'+i+'-total').html(json[i]);
        		},
        		error:function()
        		{
        			warning();
        		}
        	})
	}

	$(function(){
		// 表格初始化
		var table = showDataTable($('#showTable'), {$aoColnmns}, 100, '?m=Order&a=getCounts', {bLengthChange:false, 'order':[[8,'desc']]});
        // 分页样式
        $('#showTable_paginate').addClass('pagination pagination-centered');
        // 去掉搜索placeholder属性(不去掉白色看不见)
        $('input[type=search]').removeAttr('placeholder').on('keyup change', function(){
			setCounts();
        });

        // 添加搜索信息
        $('#showTable_filter').append('{$strSearch} <label> 开始时间: <input type="text" class="msearch time" vid="4" id="date-start" /></label>  <label> 结束时间: <input type="text" vid="5" class="msearch time" id="date-end" /></label> <label>');

        // 执行搜索
        $('.msearch').live('keyup change', function () {
        	// 之前处理查询的总数信息
        	setCounts();
            table.column(parseInt($(this).attr('vid'))).search($(this).val()).draw();
        });

		jQuery.datetimepicker.setLocale('ch');
		// 时间查询
		var mTime = {defaultTime:'00:00', onSelectDate:function(){
			$(this).hide();
		}};
		// 开始时间
		$('.time:first').datetimepicker(mTime);
		// 结束时间
		mTime.defaultTime = '23:59';
		$('.time:last').datetimepicker(mTime);

        // 隐藏内容
        $('.btn-close:first').click(function () {
            $('.main-menu li.active a').append('<span class="label">显示</span>').addClass('isShow').bind('click', function (e) {
                e.preventDefault();
                $('.row-fluid .box:last').fadeIn();
                $(this).unbind('click').find('span:last').remove();
                return false;
            });
        });

		// 游戏平台和服务器联动)
		$('#m-agentId').on('change', function(){
			$('#m-serverId').html('<option value="0"> 请选择 </option>');
			var aId = this.value;
			// 数据请求查询服务器信息
			if (!empty(aId))
			{
				$.ajax({
					url:'?m=Users&a=getLinkAge',
					type:'get',
					data:{id:aId},
					dataType:'json',
					success:function(json){
						if (json.status == 1)$('#m-serverId').html(json.data);
					},
					error:function(){
						$('.importForm_error').html('服务器繁忙,请稍候再试...').show();
					}
				})
			}
		});

		// 关闭清除数据
        $('#myModal').on('hidden.bs.modal', function(e){
            $(this).find('div.modal-body p').removeAttr('vid');
        });

        // 点击触发
        $('.delete-close').click(function(){
            var vid = $('#myModal').find('div.modal-body p').attr('vid');
            if (!empty(vid))
            {
                $.ajax({
                    url: '?m={$Think.MODULE_NAME}&a=delete',
                    type: 'get',
                    dataType: 'json',
                    data: {id: vid},
                    success: function (json) {
                        if (json.status == 1)
                        {
                            $("#myModal").modal('hide');
                            success(json.msg, function(){
                                setCounts();
                                table.draw(false);
                            });

                            return false;
                        }

                        $('.modal-body p').html('<span style="color:red">'+json.msg+'</span>');;
                    },
                    error: function () {
                        $('.modal-body p').html('<span style="color:red">服务器繁忙,请稍候再试...</span>');
                    }
                });
            }
        });

        // 删除按钮
        $('.btn-delete').live('click', function () {
            var me = $(this), vid = me.attr('vid');
            if (!empty(vid))
            {
                $('.modal-body p').html('您确定需要删除这条数据吗?').attr('vid', vid);
                $("#myModal").modal().show();
                return false;
            }

            warning('删除数据不存在');
        });
	})
</script>
<include file="Layout:indexFooter" />